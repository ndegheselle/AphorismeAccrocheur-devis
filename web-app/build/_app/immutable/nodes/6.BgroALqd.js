import{t as at,a as Z}from"../chunks/O273lVJd.js";import{p as Mt,b as R,u as xa,c as a,s as e,t as ft,g as i,a as At,e as m,r as t,j as ot,f as ya}from"../chunks/5qLNcEMJ.js";import{d as Et,s as Lt,a as Ot,b as v}from"../chunks/4hdA9Hqv.js";import{i as Yt}from"../chunks/HbRG54zj.js";import{e as ea,i as la}from"../chunks/RcQs6_xB.js";import{r as V}from"../chunks/CSdkdAZB.js";import{s as rt}from"../chunks/BcuBeYSt.js";import{b as B}from"../chunks/DNmfbV_I.js";import{p as b}from"../chunks/DEnCKr3U.js";import{b as tt}from"../chunks/BV0wr5sm.js";import{g as ha}from"../chunks/Cc1foIn1.js";import{p as Zt,S as ga}from"../chunks/DF2ny1mc.js";import{E as wa,c as Da,a as $a,r as ta,b as Ct}from"../chunks/MeLwkllz.js";import{r as St,C as aa}from"../chunks/BaDTVIYc.js";import"../chunks/C6pl-CaQ.js";import{c as ia,a as It}from"../chunks/y7u0JUKb.js";import{t as jt}from"../chunks/BkYxRAWn.js";import{o as ka}from"../chunks/z1zQKN8N.js";import{E as Ta}from"../chunks/DXdoUDVm.js";import{P as qa}from"../chunks/CSnlwC3t.js";let f=b({reference:"",issueDate:"",validityDate:"",client:"",lines:""});function Pa(c){return Object.keys(f).forEach(d=>{f[d]=""}),c.reference||(f.reference="La référence est obligatoire"),c.issueDate||(f.issueDate="La date d'émission est obligatoire"),c.validityDate||(f.validityDate="La date de validité est obligatoire"),c.clientId||(f.client="Le client est obligatoire"),c.lines.length===0&&(f.lines="Il doit y avoir au moins une ligne dans le devis"),c.issueDate&&c.validityDate&&c.validityDate<=c.issueDate&&(f.validityDate="La date de validité doit être postérieure à la date d'émission"),Object.values(f).some(d=>d!=="")}async function Ca(c,d){d(!0)}var Ia=(c,d)=>d(),Sa=(c,d,U)=>m(d,b(i(U))),Ma=at('<li><div> </div> <div class="ms-auto my-auto text-xs uppercase font-semibold opacity-60"> </div></li>'),Aa=(c,d)=>d(),Ea=(c,d)=>d(),La=at('<dialog class="modal"><div class="modal-box min-h-[30rem] flex flex-col"><button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button> <h3 class="text-lg font-bold">Sélectionner un client</h3> <label class="input w-full mt-2 input-sm"><i class="fa-solid fa-magnifying-glass opacity-50"></i> <input type="search" required placeholder="Recherche"></label> <ul class="list bg-base-100 rounded-box shadow-md mt-1"></ul> <div class="mt-auto pt-1"><!></div> <div class="modal-action mt-1"><button class="btn"> </button> <button>Sélectionner</button></div></div> <div class="modal-backdrop"><button>Close</button></div></dialog>');function Oa(c,d){Mt(d,!0);const[U,nt]=Lt(),F=()=>Ot(jt,"$t",U);let _,u,p=R(b([])),s=R(null),w=R(1),x=R(1),$=R(25),P=R("");xa(()=>{m(s,null),St.search(i(P),i(w),i($)).then(n=>{m(p,b(n.results)),m(x,b(n.total))})});function dt(n){return _=ia(),u.show(),_.promise}function C(n=!1){u.close(),_.resolve(n?i(s):null)}var k=La(),T=a(k),I=a(T);I.__click=[Ia,C];var S=e(I,4),N=e(a(S),2);V(N),t(S);var M=e(S,2);ea(M,21,()=>i(p),la,(n,D)=>{var g=Ma();let O;g.__click=[Sa,s,D];var z=a(g),K=a(z,!0);t(z);var j=e(z,2),lt=a(j,!0);t(j),t(g),ft(it=>{O=rt(g,1,"list-row p-2 cursor-pointer",null,O,it),v(K,i(D).fullName),v(lt,i(D).fullAddress)},[()=>({"bg-primary":i(D)==i(s)})]),Z(n,g)}),t(M);var H=e(M,2),Q=a(H);qa(Q,{get total(){return i(x)},set total(n){m(x,b(n))},get page(){return i(w)},set page(n){m(w,b(n))},get capacity(){return i($)},set capacity(n){m($,b(n))}}),t(H);var A=e(H,2),h=a(A);h.__click=[Aa,C];var G=a(h,!0);t(h);var J=e(h,2);let E;J.__click=[Ca,C],t(A),t(T);var L=e(T,2),et=a(L);et.__click=[Ea,C],t(L),t(k),tt(k,n=>u=n,()=>u),ft((n,D)=>{v(G,n),E=rt(J,1,"btn btn-primary",null,E,D)},[()=>F()("common.cancel"),()=>({"btn-disabled":i(s)==null})]),B(N,()=>i(P),n=>m(P,n)),Z(c,k);var W=At({show:dt,close:C});return nt(),W}Et(["click"]);var ja=(c,d)=>d(),Ra=(c,d)=>d(),Va=at('<dialog class="modal"><fieldset class="fieldset w-md modal-box bg-base-200 border border-base-300 p-4 rounded-box"><legend class="fieldset-legend">Nouvelle ligne</legend> <label class="fieldset-label" for="name">Nom *</label> <input type="text" class="input w-full" required name="name"> <div class="flex gap-2"><div><label class="fieldset-label" for="unitPrice">Prix (€) *</label> <input type="number" class="input" required name="unitPrice"></div> <div><label class="fieldset-label" for="tax">TVA (%)</label> <input type="number" class="input" required name="tax"></div> <div><label class="fieldset-label" for="quantity">Quantité</label> <input type="number" class="input" required name="quantity"></div> <div><label class="fieldset-label" for="discount">Réduction (%)</label> <input type="number" class="input" required name="discount"></div></div> <p class="fieldset-label"> </p> <div class="ms-auto flex w-20"><span class="font-thin opacity-50">HT</span> <span class="ms-auto text-right"> </span></div> <div class="ms-auto flex w-20"><span class="font-thin opacity-50">TVA</span> <span class="ms-auto text-right"> </span></div> <div class="ms-auto flex w-20"><span class="font-thin opacity-50">TTC</span> <span class="ms-auto text-right"> </span></div> <div class="modal-action"><button class="btn"> </button> <button class="btn btn-primary"> </button></div></fieldset> <div class="modal-backdrop"><button>Close</button></div></dialog>');function Ba(c,d){Mt(d,!0);const[U,nt]=Lt(),F=()=>Ot(jt,"$t",U);let _,u,p,s=b({name:"",unitPrice:1,quantity:1,tax:20,discount:0}),w=R(!1),x=ot(()=>s.unitPrice*s.quantity*(1-s.discount/100)),$=ot(()=>i(x)*s.tax/100),P=ot(()=>i(x)+i($));function dt(o=null){return o&&(s.name=o.name,s.unitPrice=o.unitPrice,s.quantity=o.quantity,s.tax=o.tax,s.discount=o.discount),m(w,!!o),p=ia(),u.show(),p.promise}async function C(){k(!0)}function k(o=!1){if(o){let q=new wa;q.name=s.name,q.unitPrice=s.unitPrice,q.quantity=s.quantity,q.tax=s.tax,q.discount=s.discount,p.resolve(q)}else p.resolve(null);u.close()}var T=Va(),I=a(T),S=e(a(I),4);V(S);var N=e(S,2),M=a(N),H=e(a(M),2);V(H),t(M);var Q=e(M,2),A=e(a(Q),2);V(A),t(Q);var h=e(Q,2),G=e(a(h),2);V(G),t(h);var J=e(h,2),E=e(a(J),2);V(E),t(J),t(N);var L=e(N,2),et=a(L,!0);t(L);var W=e(L,2),n=e(a(W),2),D=a(n);t(n),t(W);var g=e(W,2),O=e(a(g),2),z=a(O);t(O),t(g);var K=e(g,2),j=e(a(K),2),lt=a(j);t(j),t(K);var it=e(K,2),X=a(it);X.__click=()=>u.close();var bt=a(X,!0);t(X);var ct=e(X,2);ct.__click=[ja,C];var st=a(ct,!0);t(ct),t(it),t(I),tt(I,o=>_=o,()=>_);var ut=e(I,2),_t=a(ut);_t.__click=[Ra,k],t(ut),t(T),tt(T,o=>u=o,()=>u),ft((o,q)=>{v(et,o),v(D,`${i(x)??""} €`),v(z,`${i($)??""} €`),v(lt,`${i(P)??""} €`),v(bt,q),v(st,i(w)?"Modifier":"Ajouter")},[()=>F()("common.fields.required"),()=>F()("common.cancel")]),B(S,()=>s.name,o=>s.name=o),B(H,()=>s.unitPrice,o=>s.unitPrice=o),B(A,()=>s.tax,o=>s.tax=o),B(G,()=>s.quantity,o=>s.quantity=o),B(E,()=>s.discount,o=>s.discount=o),Z(c,T);var vt=At({show:dt,close:k});return nt(),vt}Et(["click"]);var Na=at('<tr><td> </td><td> </td><td> </td><td> </td><td> </td><td><button class="btn btn-ghost" aria-label="Actions" popovertarget="line-edit" style="anchor-name:--anchor-1"><i class="fa-solid fa-ellipsis"></i></button></td></tr>'),Ha=(c,d)=>m(d,null),Qa=at('<button class="ms-auto btn btn-sm btn-circle" aria-label="Modifier client"><i class="fa-solid fa-close"></i></button>'),Wa=at('<div class=" m-auto flex flex-col"><button class="btn"><i class="fa-solid fa-user"></i> Sélectionner un client</button> <div class="divider">OU</div> <button class="btn mx-auto"><i class="fa-solid fa-plus"></i> Créer un client</button></div>'),za=at(`<div class="container mx-auto py-4 h-full flex flex-col"><div class="flex"><h1 class="text-2xl my-auto font-thin w-full">Devis</h1> <button class="ms-2 btn btn-primary"><i class="fa-solid fa-save"></i> Sauvegarder</button> <button class="ms-2 btn btn-circle" aria-label="Ajouter une ligne"><i class="fa-solid fa-plus"></i></button></div> <div class="flex-grow overflow-y-auto mt-2 overflow-x-auto rounded-box border border-base-content/5 bg-base-200"><table class="table table-xs table-pin-rows table-pin-cols"><thead><tr><td width="100%">Nom</td><td>Prix (€)</td><td>Quantité</td><td>TVA (%)</td><td>Réduction (%)</td><th></th></tr></thead><tbody></tbody></table></div> <div class="grid grid-cols-1 lg:grid-cols-6 mt-2 gap-2"><div class="card bg-base-200 shadow-md col-span-2 lg:col-span-1 lg:col-start-6 order-first lg:order-last"><div class="card-body"><h2 class="card-title">Total</h2> <div><div class="flex"><span class="font-thin opacity-50">HT</span> <span class="ms-auto text-right"> </span></div> <div class="flex"><span class="font-thin opacity-50">TVA</span> <span class="ms-auto text-right"> </span></div> <div class="flex"><span class="font-thin opacity-50">TTC</span> <span class="ms-auto text-right"> </span></div></div></div></div> <div><div class="card-body"><div class="flex"><h2 class="card-title"><i class="fa-solid fa-user"></i> Client</h2> <!></div> <!></div></div> <div class="col-span-2 card bg-base-200 shadow-md"><div class="card-body"><h2 class="card-title">Infos</h2> <fieldset class="fieldset p-0"><label data-tip="Référence"><i class="fa-solid fa-hashtag opacity-50"></i> <input type="text" class="grow" placeholder="Référence"></label> <p class="fieldset-label text-error"> </p> <label data-tip="Date"><i class="fa-solid fa-calendar-day opacity-50"></i> <input type="date" class="grow" placeholder="Date"></label> <p class="fieldset-label text-error"> </p> <label data-tip="Date d'échéance"><i class="fa-solid fa-calendar-xmark opacity-50"></i> <input type="date" class="grow" placeholder="Date d'échéance"></label> <p class="fieldset-label text-error"> </p></fieldset></div></div></div></div> <ul class="dropdown menu w-52 rounded-box bg-base-100 shadow-sm" popover="" id="line-edit" style="position-anchor:--anchor-1"><li><button><i class="fa-solid fa-pen"></i> Modifier</button></li> <li><button class="text-error"><i class="fa-solid fa-trash"></i> Supprimer</button></li></ul> <!> <!> <!>`,1);function ve(c,d){Mt(d,!0);const[U,nt]=Lt(),F=()=>Ot(jt,"$t",U);let _=R(null),u=R(b([])),p=b({reference:Da(),issueDate:new Date().toISOString().split("T")[0],validityDate:null}),s=null,w,x=null,$,P,dt=ot(()=>i(u).reduce((l,r)=>l+r.totalWithoutTax,0)),C=ot(()=>i(u).reduce((l,r)=>l+r.totalTax,0)),k=ot(()=>i(u).reduce((l,r)=>l+r.total,0));ka(async()=>{let l=Zt.url.searchParams.get("clientId"),r=Zt.url.searchParams.get("basedOn");if(r){let y=await ta.getById(r);m(u,b(y.lines)),m(_,b(await St.getById(y.clientId)))}else l&&m(_,b(await St.getById(l)))});async function T(){let l=await w.show();l!=null&&i(u).push(l)}function I(){s!=null&&(x==null||x.togglePopover(!1),m(u,b(i(u).filter(l=>l!==s))))}async function S(){if(s==null)return;let l=await w.show(s);if(l==null)return;let r=i(u).indexOf(s);r!==-1&&(i(u)[r]=l)}async function N(){m(_,b(await $.show(new aa)))}async function M(){m(_,b(await P.show(new aa)))}async function H(){var r;let l=new $a;if(l.clientId=(r=i(_))==null?void 0:r.$id,l.lines=i(u),l.reference=p.reference,l.issueDate=p.issueDate?new Date(Date.parse(p.issueDate)):void 0,l.validityDate=p.validityDate?new Date(Date.parse(p.validityDate)):void 0,Pa(l)){It.error(Object.values(f).filter(Boolean).join(", "));return}try{l=await ta.create(l),ha(`/estimates/${l.$id}`),It.success(F()("estimates.create.success"))}catch(y){console.error(y),It.error(F()("estimates.create.error"))}}var Q=za(),A=ya(Q),h=a(A),G=e(a(h),2);G.__click=H;var J=e(G,2);J.__click=T,t(h);var E=e(h,2),L=a(E),et=e(a(L));ea(et,21,()=>i(u),la,(l,r)=>{var y=Na(),Y=a(y),$t=a(Y,!0);t(Y);var pt=e(Y),kt=a(pt,!0);t(pt);var Tt=e(pt),fa=a(Tt,!0);t(Tt);var qt=e(Tt),ba=a(qt,!0);t(qt);var Pt=e(qt),_a=a(Pt,!0);t(Pt);var Xt=e(Pt),ma=a(Xt);ma.__click=()=>{s=i(r)},t(Xt),t(y),ft(()=>{v($t,i(r).name),v(kt,i(r).unitPrice),v(fa,i(r).quantity),v(ba,i(r).tax),v(_a,i(r).discount)}),Z(l,y)}),t(et),t(L),t(E);var W=e(E,2),n=a(W),D=a(n),g=e(a(D),2),O=a(g),z=e(a(O),2),K=a(z);t(z),t(O);var j=e(O,2),lt=e(a(j),2),it=a(lt);t(lt),t(j);var X=e(j,2),bt=e(a(X),2),ct=a(bt);t(bt),t(X),t(g),t(D),t(n);var st=e(n,2);let ut;var _t=a(st),vt=a(_t),o=e(a(vt),2);{var q=l=>{var r=Qa();r.__click=[Ha,_],Z(l,r)};Yt(o,l=>{i(_)&&l(q)})}t(vt);var sa=e(vt,2);{var ra=l=>{ga(l,{get client(){return i(_)}})},oa=l=>{var r=Wa(),y=a(r);y.__click=M;var Y=e(y,4);Y.__click=N,t(r),Z(l,r)};Yt(sa,l=>{i(_)?l(ra):l(oa,!1)})}t(_t),t(st);var Rt=e(st,2),Vt=a(Rt),Bt=e(a(Vt),2),mt=a(Bt);let Nt;var Ht=e(a(mt),2);V(Ht),t(mt);var gt=e(mt,2),na=a(gt,!0);t(gt);var xt=e(gt,2);let Qt;var Wt=e(a(xt),2);V(Wt),t(xt);var wt=e(xt,2),da=a(wt,!0);t(wt);var yt=e(wt,2);let zt;var Ut=e(a(yt),2);V(Ut),t(yt);var Ft=e(yt,2),ca=a(Ft,!0);t(Ft),t(Bt),t(Vt),t(Rt),t(W),t(A);var ht=e(A,2),Dt=a(ht),ua=a(Dt);ua.__click=S,t(Dt);var Gt=e(Dt,2),va=a(Gt);va.__click=I,t(Gt),t(ht),tt(ht,l=>x=l,()=>x);var Jt=e(ht,2);tt(Ba(Jt,{}),l=>w=l,()=>w);var Kt=e(Jt,2);tt(Ta(Kt,{}),l=>$=l,()=>$);var pa=e(Kt,2);tt(Oa(pa,{}),l=>P=l,()=>P),ft((l,r,y,Y,$t,pt,kt)=>{v(K,`${l??""} €`),v(it,`${r??""} €`),v(ct,`${y??""} €`),ut=rt(st,1,"col-span-2 min-h-40 card card-dash bg-base-200 shadow-md svelte-1tolpoz",null,ut,Y),Nt=rt(mt,1,"input w-full tooltip tooltip-left",null,Nt,$t),v(na,f.reference),Qt=rt(xt,1,"input w-full tooltip tooltip-left",null,Qt,pt),v(da,f.issueDate),zt=rt(yt,1,"input w-full tooltip tooltip-left",null,zt,kt),v(ca,f.validityDate)},[()=>Ct(i(dt)),()=>Ct(i(C)),()=>Ct(i(k)),()=>({"border-error":f.client}),()=>({"input-error":f.reference}),()=>({"input-error":f.issueDate}),()=>({"input-error":f.validityDate})]),B(Ht,()=>p.reference,l=>p.reference=l),B(Wt,()=>p.issueDate,l=>p.issueDate=l),B(Ut,()=>p.validityDate,l=>p.validityDate=l),Z(c,Q),At(),nt()}Et(["click"]);export{ve as component};
